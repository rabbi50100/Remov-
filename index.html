<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>প্রফেশনাল রিয়েল-টাইম ব্যাকগ্রাউন্ড রিমুভার</title>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest/dist/tf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/body-pix@latest/dist/body-pix.min.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            margin: 0;
            padding: 20px;
            color: #333;
            min-height: 100vh;
        }
        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        h1 {
            text-align: center;
            color: #4a5568;
            margin-bottom: 10px;
        }
        .subtitle {
            text-align: center;
            color: #718096;
            margin-bottom: 30px;
        }
        .upload-section {
            text-align: center;
            margin-bottom: 20px;
        }
        input[type="file"] {
            background: #f7fafc;
            border: 2px dashed #cbd5e0;
            padding: 20px;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
        }
        input[type="file"]:hover {
            border-color: #4a90e2;
            background: #edf2f7;
        }
        .preview-section {
            display: flex;
            justify-content: space-around;
            flex-wrap: wrap;
            gap: 20px;
            margin: 20px 0;
        }
        .preview-item {
            flex: 1;
            min-width: 300px;
            text-align: center;
        }
        canvas {
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            max-width: 100%;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }
        .controls {
            text-align: center;
            margin: 20px 0;
        }
        .slider-container {
            margin: 10px 0;
            display: inline-block;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        input[type="range"] {
            width: 200px;
        }
        button {
            background: linear-gradient(135deg, #4CAF50, #45a049);
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            margin: 5px;
            font-size: 16px;
            transition: all 0.3s;
            box-shadow: 0 4px 10px rgba(76, 175, 80, 0.3);
        }
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(76, 175, 80, 0.4);
        }
        #downloadPngBtn {
            background: linear-gradient(135deg, #2196F3, #1976D2);
            box-shadow: 0 4px 10px rgba(33, 150, 243, 0.3);
        }
        #downloadPngBtn:hover {
            box-shadow: 0 6px 15px rgba(33, 150, 243, 0.4);
        }
        #downloadJpgBtn {
            background: linear-gradient(135deg, #FF9800, #F57C00);
            box-shadow: 0 4px 10px rgba(255, 152, 0, 0.3);
        }
        #downloadJpgBtn:hover {
            box-shadow: 0 6px 15px rgba(255, 152, 0, 0.4);
        }
        .loading {
            display: none;
            text-align: center;
            margin: 20px 0;
        }
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #4CAF50;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .error {
            color: #e53e3e;
            text-align: center;
            margin: 10px 0;
        }
        @media (max-width: 768px) {
            .preview-section {
                flex-direction: column;
            }
            .preview-item {
                min-width: auto;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>প্রফেশনাল রিয়েল-টাইম ব্যাকগ্রাউন্ড রিমুভার</h1>
        <p class="subtitle">AI-ভিত্তিক টুল দিয়ে যেকোনো কালারের ব্যাকগ্রাউন্ড রিয়েল-টাইমে রিমুভ করুন। স্বচ্ছ PNG ডাউনলোড করুন!</p>
        
        <div class="upload-section">
            <input type="file" id="imageInput" accept="image/*">
        </div>
        
        <div class="loading" id="loading">
            <div class="spinner"></div>
            <p>AI মডেল লোড হচ্ছে এবং ব্যাকগ্রাউন্ড রিমুভ করা হচ্ছে... (প্রথমবারে কিছুক্ষণ লাগতে পারে)</p>
        </div>
        
        <div class="error" id="error" style="display:none;"></div>
        
        <div class="preview-section">
            <div class="preview-item">
                <h3>অরিজিনাল ইমেজ</h3>
                <canvas id="originalCanvas"></canvas>
            </div>
            <div class="preview-item">
                <h3>ব্যাকগ্রাউন্ড রিমুভড</h3>
                <canvas id="processedCanvas"></canvas>
            </div>
        </div>
        
        <div class="controls">
            <div class="slider-container">
                <label for="confidenceSlider">কনফিডেন্স থ্রেশহোল্ড (নির্ভুলতা): <span id="confidenceValue">0.75</span></label>
                <input type="range" id="confidenceSlider" min="0.5" max="0.95" step="0.05" value="0.75" onchange="updateThreshold()">
            </div>
            <br>
            <button id="processBtn" onclick="processImage()" style="display:none;">ফিরে প্রসেস করুন</button>
            <button id="downloadPngBtn" onclick="downloadImage('png')" style="display:none;">PNG ডাউনলোড (স্বচ্ছ)</button>
            <button id="downloadJpgBtn" onclick="downloadImage('jpg')" style="display:none;">JPG ডাউনলোড</button>
        </div>
    </div>

    <script>
        let net = null;
        let originalImage = null;
        let processedCanvas = document.getElementById('processedCanvas');
        let originalCanvas = document.getElementById('originalCanvas');
        let ctxOriginal = originalCanvas.getContext('2d');
        let ctxProcessed = processedCanvas.getContext('2d');
        let confidenceThreshold = 0.75;

        const imageInput = document.getElementById('imageInput');
        const loading = document.getElementById('loading');
        const error = document.getElementById('error');
        const processBtn = document.getElementById('processBtn');
        const downloadPngBtn = document.getElementById('downloadPngBtn');
        const downloadJpgBtn = document.getElementById('downloadJpgBtn');
        const confidenceValue = document.getElementById('confidenceValue');

        // TensorFlow.js এবং BodyPix লোড করুন
        async function loadModel() {
            try {
                net = await bodyPix.load({
                    architecture: 'MobileNetV1',
                    outputStride: 16,
                    internalResolution: 'low',
                    multiplier: 0.50,
                    quantBytes: 2
                });
                console.log('AI মডেল লোড হয়েছে!');
            } catch (err) {
                showError('মডেল লোড করতে সমস্যা: ' + err.message);
            }
        }

        // ইমেজ আপলোড হ্যান্ডলার
        imageInput.addEventListener('change', async function(event) {
            const file = event.target.files[0];
            if (file) {
                showLoading(true);
                error.style.display = 'none';
                
                const reader = new FileReader();
                reader.onload = async function(e) {
                    originalImage = new Image();
                    originalImage.onload = async function() {
                        // ক্যানভাস সাইজ সেট করুন
                        const maxSize = 400;
                        let { width, height } = originalImage;
                        if (width > maxSize || height > maxSize) {
                            const ratio = Math.min(maxSize / width, maxSize / height);
                            width *= ratio;
                            height *= ratio;
                        }
                        originalCanvas.width = processedCanvas.width = width;
                        originalCanvas.height = processedCanvas.height = height;

                        // অরিজিনাল ড্র
                        ctxOriginal.drawImage(originalImage, 0, 0, width, height);

                        // মডেল লোড যদি না হয়
                        if (!net) {
                            await loadModel();
                        }

                        // রিয়েল-টাইম প্রসেস
                        await processBackground();
                        showLoading(false);
                        processBtn.style.display = 'inline-block';
                        downloadPngBtn.style.display = 'inline-block';
                        downloadJpgBtn.style.display = 'inline-block';
                    };
                    originalImage.src = e.target.result;
                };
                reader.readAsDataURL(file);
            }
        });

        // ব্যাকগ্রাউন্ড রিমুভ প্রসেস
        async function processBackground() {
            if (!net || !originalImage) return;

            const segmentation = await net.segmentPerson(originalImage, {
                segmentationThreshold: confidenceThreshold,
                flipHorizontal: false
            });

            // মাস্ক তৈরি
            const maskBackground = true; // ব্যাকগ্রাউন্ড মাস্ক
            const foregroundColor = {r: 0, g: 0, b: 0, a: 0}; // স্বচ্ছ
            const backgroundColor = {r: 0, g: 0, b: 0, a: 0}; // স্বচ্ছ ব্যাকগ্রাউন্ড

            const coloredMask = bodyPix.toColoredMask(segmentation, foregroundColor, backgroundColor, maskBackground);
            const maskData = coloredMask.data;

            // অরিজিনাল ইমেজ ড্র
            ctxProcessed.drawImage(originalImage, 0, 0, processedCanvas.width, processedCanvas.height);

            // মাস্ক অ্যাপ্লাই (পিক্সেল বাই পিক্সেল)
            const imageData = ctxProcessed.getImageData(0, 0, processedCanvas.width, processedCanvas.height);
            const data = imageData.data;
            for (let i = 0; i < maskData.length; i += 4) {
                const maskAlpha = maskData[i + 3]; // মাস্কের অ্যালফা
                if (maskAlpha === 0) { // ব্যাকগ্রাউন্ড
                    data[i + 3] = 0; // স্বচ্ছ করুন
                } else {
                    data[i + 3] = 255; // ফরগ্রাউন্ড অপারেন্ট
                }
            }
            ctxProcessed.putImageData(imageData, 0, 0);
        }

        // থ্রেশহোল্ড আপডেট
        function updateThreshold() {
            confidenceThreshold = parseFloat(document.getElementById('confidenceSlider').value);
            confidenceValue.textContent = confidenceThreshold.toFixed(2);
            if (originalImage) {
                processBackground(); // রি-প্রসেস
            }
        }

        // ডাউনলোড
        function downloadImage(format) {
            if (!processedCanvas) return;
            const link = document.createElement('a');
            link.download = `removed-bg.${format}`;
            link.href = processedCanvas.toDataURL(`image/${format === 'png' ? 'png' : 'jpeg'}`);
            link.click();
        }

        // প্রসেস বাটন
        async function processImage() {
            showLoading(true);
            await processBackground();
            showLoading(false);
        }

        // হেল্পার ফাংশন
        function showLoading(show) {
            loading.style.display = show ? 'block' : 'none';
        }
        function showError(msg) {
            error.textContent = msg;
            error.style.display = 'block';
            showLoading(false);
        }

        // পেজ লোডে মডেল প্রি-লোড (অপশনাল)
        window.onload = loadModel;
    </script>
</body>
    </html>
